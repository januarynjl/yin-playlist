<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>懒銀歌单</title>
    <link rel="shortcut icon" href="favicon.ico">
    <!-- 引入 layui.css -->
    <link href="https://unpkg.com/layui@2.11.4/dist/css/layui.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
<!-- HTML Content -->
<div class="layui-fluid" style="padding: 20px;">
    <!-- 页面标题区域 -->
    <div class="page-header" style="text-align: center; position: relative;">
        <div style="display: inline-block; position: relative;">
            <h1 style="color: var(--text-primary);  font-size: 28px; font-weight: 700; position: relative; display: inline-block;">
                <i class="layui-icon layui-icon-music" style="color: var(--primary-color); margin-right: 10px; font-size: 32px;"></i>
                懒銀歌单
            </h1>
        </div>
        <p style="color: var(--text-secondary); font-size: 16px; ">
            <i class="layui-icon layui-icon-date" style="color: var(--accent-color); margin-right: 5px;"></i>
            2026直播天数【<span class="count" id="dateCount">0</span>】
        </p>
        <div style="width: 100px; height: 4px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); border-radius: 2px; margin: 15px auto 0;"></div>
    </div>
    
    <div class="layui-card">
        <div class="layui-card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">
                    歌曲列表
                </h3>
                <span style="color: var(--primary-color); font-weight: bold;">
                    共 <span class="count" id="count">0</span> 首歌曲
                </span>
            </div>
        </div>
        <!-- 搜索表单 - 移到卡片外部，确保下拉框不受表格影响 -->
        <div style="position: relative; z-index: 10000; padding: 15px 20px; background-color: white; border-bottom: 1px solid #e6e6e6;">
            <form class="layui-form layui-row layui-col-space16"  lay-filter="search-filter">
                <div class="layui-col-md3">
                    <div class="layui-input-wrap" style="border-radius: 8px; overflow: hidden;">
                        <input type="text" name="sName" value="" placeholder="歌名" class="layui-input" lay-affix="clear" style="border-radius: 8px;">
                    </div>
                </div>
                <div class="layui-col-md3">
                    <div class="layui-input-wrap" style="border-radius: 8px; overflow: hidden;">
                        <input type="text" name="sSinger" placeholder="歌手" lay-affix="clear" class="layui-input" style="border-radius: 8px;">
                    </div>
                </div>
                <div class="layui-col-md3">
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <select name="sSign" >
                                <option value="">风格</option>
                                <option value="悲伤情歌">悲伤情歌</option>
                                <option value="古风国风">古风国风</option>
                                <option value="活泼可爱">活泼可爱</option>
                                <option value="温柔治愈">温柔治愈</option>
                                <option value="民谣乐队杂食">民谣乐队杂食</option>
                                <option value="外语杂食">外语杂食</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md3">
                    <div class="layui-input-wrap" style="border-radius: 8px; overflow: hidden;">
                        <input type="text" name="sPre" placeholder="首字母/语种" lay-affix="clear" class="layui-input" style="border-radius: 8px;">
                    </div>
                </div>
                <div class="layui-btn-container layui-col-xs12" style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="layui-btn search-btn" lay-submit lay-filter="playlist-search" id="btn-submit">
                        <i class="layui-icon layui-icon-search" style="margin-right: 5px;"></i>搜索
                    </button>
                    <button type="reset" class="layui-btn layui-btn-primary"  id="btn-clear">
                        <i class="layui-icon layui-icon-refresh" style="margin-right: 5px;"></i>清除
                    </button>
                    <button type="button" class="layui-btn layui-btn-primary" lay-on="test-page-wrap">
                        <i class="layui-icon layui-icon-fire" style="margin-right: 5px;"></i>热门歌曲
                    </button>
                    <button type="button" class="layui-btn layui-btn-primary" id="live-date">
                        <i class="layui-icon layui-icon-date" style="margin-right: 5px;"></i>直播日历
                    </button>
                    <input type="hidden" id="live-date-val">
                </div>
            </form>
        </div>
        
        <!-- 歌曲表格 -->
        <div class="layui-card-body" style="padding: 15px 20px;">
            <table class="layui-table" id="playList-table"></table>
        </div>
    </div>

</div>
<div id="rank-page" style="display: none;">
    <div style="padding: 20px; min-width: 600px;">
        <table class="" id="rank-table"></table>
    </div>
</div>
<!-- 引入 layui.js -->
<script src="https://unpkg.com/layui@2.11.4/dist/layui.js"></script>
<script>
    var playList_origin;
    layui.define(['jquery'], function(exports){
        var $ = layui.jquery;

        var fetchData = function(url, callback) {
            $.getJSON(url, function(data) {
                callback(data);
            });
        };

        exports('dataModule', {fetchData: fetchData}); // 导出模块功能
    });


    // Usage
    layui.use(function(){
        var $ = layui.$;
        var form = layui.form;
        var table = layui.table;
        var dataModule = layui.dataModule;
        var util = layui.util;
        var laydate = layui.laydate;
        
        // 渲染表单元素
        form.render();

        var broadcastMap = new Map();
        var liveDateList_A;
        var liveDateList_B;
        var liveDateList;
        
        // 加载所有数据后再初始化日期控件
        function initDateControl() {
            if (broadcastMap.size > 0 && liveDateList_A && liveDateList_B && liveDateList) {
                // 渲染
                laydate.render({
                    eventElem: '#live-date',
                    trigger: 'click',
                    elem: '#live-date-val',
                    value: new Date(new Date().setDate(new Date().getDate() - 1)),
                    id:'live-date',
                    //holidays:[data,[]],
                    showBottom: true,
                    autoConfirm : false,
                    btns: [],
                    theme: ['#ff98a0','grid'],
                    disabledDate: function(date, type){
                        return date.getTime() > Date.now();
                    },

                    change: function(value, date) {
                        this.cellRender(date);
                        $("#live-date").text("直播日历");
                    },
                    ready: function (date) {
                    var that = this;
                    
                    // 延迟获取面板元素，确保DOM已完全渲染
                    setTimeout(function() {
                        // 直接获取最新打开的laydate面板
                        var panelEl = $('.layui-laydate:last');
                        
                        // 确保预览元素存在，如果不存在则创建
                        that._previewEl = panelEl.find('.layui-laydate-preview');
                        if (!that._previewEl.length) {
                            // 创建预览元素
                            that._previewEl = $('<div class="layui-laydate-preview" style="padding: 10px; border-top: 1px solid #e6e6e6;"></div>');
                            panelEl.find('.layui-laydate-main').after(that._previewEl);
                        }
                        
                        // 手动构建当前日期对象，确保格式正确
                        var today = new Date(new Date().setDate(new Date().getDate() - 1));
                        var currentDate = {
                            year: today.getFullYear(),
                            month: today.getMonth() + 1,
                            date: today.getDate()
                        };
                        
                        // 直接渲染录播链接，不依赖 cellRender
                        var y = currentDate.year;
                        var m = currentDate.month;
                        var d = currentDate.date;
                        var dateStr = layui.util.toDateString(new Date(y, m-1, d), 'yyyy-MM-dd');
                        
                        if (broadcastMap.has(dateStr)) {
                            let broadcastList = broadcastMap.get(dateStr);
                            let text = '';
                            for (let i = 0; i < broadcastList.length; i++) {
                                text += '<a class="broadcost_'+broadcastList[i].pt+' layui-btn layui-btn-xs layui-btn-normal" target="_blank" href="'+broadcastList[i].url+'">'+broadcastList[i].pt+'录播链接' + '</a>';
                            }
                            var tipsText = [
                                '<div class="preview-inner">',
                                text,
                                '</div>'
                            ].join('');
                            that._previewEl.html(tipsText);
                        } else {
                            var tipsText = [
                                '<div class="preview-inner">',
                                '<div style="color:#333;">暂无录播</div>',
                                '</div>'
                            ].join('');
                            that._previewEl.html(tipsText);
                        }
                        
                        // 设置输入框值
                        that.elem.val(dateStr);
                    }, 100);
                },
                    cellRender: function (ymd, render, info) {
                        var that = this;
                        var y = ymd.year;
                        var m = ymd.month;
                        var d = ymd.date;
                        var date = layui.util.toDateString(new Date(y, m-1, d), 'yyyy-MM-dd');
                        if (that._previewEl && (!info || (info && info.type === "date"))) {

                            if(broadcastMap.has(date)){
                                let broadcastList = broadcastMap.get(date);
                                let text = '';
                                for (let i = 0; i < broadcastList.length; i++) {
                                    text += '<a class="broadcost_'+broadcastList[i].pt+' layui-btn layui-btn-xs layui-btn-normal" target="_blank" href="'+broadcastList[i].url+'">'+broadcastList[i].pt+'录播链接' + '</a>';
                                }
                                var tipsText = [
                                    '<div class="preview-inner">',
                                    text,
                                    '</div>'
                                ].join('');
                                that._previewEl.html(tipsText);
                            }else{
                                var tipsText = [
                                    '<div class="preview-inner">',
                                    '<div style="color:#333;">暂无录播</div>',
                                    '</div>'
                                ].join('');
                                that._previewEl.html(tipsText);
                            }
                        }
                        if (!render) return;

                        var is_A = liveDateList_A.includes(date);
                        var is_B = liveDateList_B.includes(date);
                        if (info.type == 'date') {
                            var clazz = [
                                'date-cell-inner',
                                is_A ? 'laydate-day-holidays' : '',
                                is_B ? 'laydate-B' : '',
                            ].join(' ');
                            var content = [
                                '<div class="' + clazz + '">',
                                '<b>' + d + '</b>',
                                '</div>',
                            ].join('');
                            // render(content)
                            // render($(content)[0])
                            var contentEl = $(content);
                            render(contentEl);
                        }
                    }
                });
            }
        }
        
        // 加载 broadcastMap
        dataModule.fetchData('./data/broadcastMap.json', function(data) {
            Object.entries(data).forEach(([key, value]) => {
                broadcastMap.set(key, value);
            });
            initDateControl();
        });
        
        // 加载 liveDateList_A
        dataModule.fetchData('./data/liveDateList_A.json', function(data) {
            liveDateList_A = data;
            initDateControl();
        });
        
        // 加载 liveDateList_B
        dataModule.fetchData('./data/liveDateList_B.json', function(data) {
            liveDateList_B = data;
            initDateControl();
        });
        
        // 加载 liveDateList_2026
        dataModule.fetchData('./data/liveDateList_2026.json', function(data) {
            $("#dateCount").text(data.length);
        });
        
        // 加载 liveDateList
        dataModule.fetchData('./data/liveDateList.json', function(data) {
            liveDateList = data;
            initDateControl();
        });

        util.fixbar({
            top: true //返回顶部
            , css: { right: 15, bottom: 35,'border-radius': '50px' }
            , bgcolor: '#ff98a0'
            , click: function (type) {

            }
        });
        util.on('lay-on', {
            'test-page-wrap': function () {
                layer.open({
                    type: 1,
                    title: "热门歌曲 统计时间：01-29 24:00",
                    shade: 0.3, // 不显示遮罩
                    content: $('#rank-page'), // 捕获的元素
                    end: function () {
                        // layer.msg('关闭后的回调', {icon:6});
                    }
                });
            }
        });
        dataModule.fetchData('./data/playList.json', function(data) {
            playList_origin = data;
            $("#count").text(data.length);
            playList = playList_origin;
            // 创建表格实例
            table.render({
                elem: '#playList-table',
                size:'lg',
                data: playList,
                cols: [[
                    {type: 'numbers', title: '序号',width:60},
                    {field:'sName', title: '歌名',maxWidth:300,minWidth:150, templet: function(d) {
                            return d.sName+ (d.isHot > 0  ? '<img src="img/hot.gif" >' : '')+ (d.isNew> 0  ? '<img src="img/new.gif" >' : '');
                        }},
                    {field:'sSinger', title: '歌手', width:150},
                    {field:'sSign', title: '风格', width:120},
                    {field:'sumCount', title: '点歌次数', width:90},
                    {field:'sPre', title: '首字母/语种', width:110}/*,
                    {field:'sUpDown', title: '升降调',  width:80}*/
                ]],

                //skin: 'line', // 表格风格
                even: true,
                page: false, // 是否显示分页
                limits: [10, 20, 50],
                limit: 20 // 每页默认显示的数量
            });

            var rankList = playList_origin.filter(song => song.isHot>0);
            rankList.sort(function (a,b) {

                return b.sumCount - a.sumCount == 0
                    ? (b.updateTime-a.updateTime ):(b.sumCount - a.sumCount);
            });

            // 点歌次数
            table.render({
                elem: '#rank-table',
                size:'lg',
                data: rankList,
                cols: [[
                    {field:'sName', title: '歌名',width:140},
                    {field:'sumCount', title: '点歌次数', width:90},
                    {field:'aCount', title: 'A', width:60, sort: true},
                    {field:'bCount', title: 'B', width:60, sort: true},
                    {field:'sSinger', title: '歌手', width:150},
                    {field:'sSign', title: '风格', width:120}
                ]],

                //skin: 'line', // 表格风格
                even: true,
                page: false, // 是否显示分页
            });
        });
        $('#btn-submit').on('click', function(){
            form.submit('search-filter', function(data){
                var field = data.field; // 获取表单全部字段值
                console.log(field);// 回调函数返回的 data 参数和提交事件中返回的一致
                search(field);

            });
            return false;
        });
        $('#btn-clear').on('click', function(){
            search({sName: '', sSinger: '', sSign: '', sPre: ''})
        });


        function search(field){
            let filter_list = []
            let cdata = playList_origin;
            if(field.sName == "" && field.sSinger == "" && field.sSign == ""  && field.sPre == ""){
                filter_list = cdata;
            }else if(field.sPre =="open"){
                table.reload('playList-table', {
                    cols: [[
                        {type: 'numbers', title: '序号',width:60},
                        {field:'sName', title: '歌名',maxWidth:300,minWidth:150},
                        {field:'sSinger', title: '歌手', width:150},
                        {field:'sSign', title: '风格', width:120},
                        {field:'sumCount', title: '点歌次数', width:90},
                        {field:'sPre', title: '首字母/语种', width:110},
                        {field:'sUpDown', title: '升降调',  width:80}
                    ]],
                });
            }else{
                $.each(cdata, function (i, row) {
                    var isSearchInRow_sName = false
                    var isSearchInRow_sSinger = false;
                    var isSearchInRow_sSign = false;
                    var isSearchInRow_sPre = false;
                    if(field.sName != "" && row.sName.toUpperCase().indexOf(field.sName.toUpperCase())> -1){
                        isSearchInRow_sName = true;
                    }else{
                        if(field.sName == ""){
                            isSearchInRow_sName = true;
                        }
                    }
                    if(field.sSinger != "" && row.sSinger.toUpperCase().indexOf(field.sSinger.toUpperCase())> -1){
                        isSearchInRow_sSinger = true;
                    }else{
                        if(field.sSinger == ""){
                            isSearchInRow_sSinger = true;
                        }
                    }
                    if(field.sSign != "" && row.sSign.indexOf(field.sSign)> -1){
                        isSearchInRow_sSign = true;
                    }else{
                        if(field.sSign == ""){
                            isSearchInRow_sSign = true;
                        }
                    }
                    if(field.sPre != "" && (row.sPre.indexOf(field.sPre)> -1 || row.sPre == field.sPre.toUpperCase())){
                        isSearchInRow_sPre = true;
                    }else{
                        if(field.sPre == ""){
                            isSearchInRow_sPre = true;
                        }
                    }
                    if (isSearchInRow_sName && isSearchInRow_sSinger && isSearchInRow_sSign && isSearchInRow_sPre) {
                        filter_list.push(row)

                    }
                });
            }
            // 执行搜索重载
            table.reload('playList-table', {
                data: filter_list,
            });
        }
    });

</script>
</body>
</html>