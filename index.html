<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>懒銀歌单</title>
    <link rel="shortcut icon" href="favicon.ico">
    <!-- 引入 layui.css -->
    <link href="//unpkg.com/layui@2.11.4/dist/css/layui.css" rel="stylesheet">
    <style type="text/css">
        .layui-fixbar li{
            border-radius: 50px;
        }
        .search-btn{
            background-color: #ff98a0;
        }
        .layui-input:focus, .layui-textarea:focus {
            border-color: #ff98a0 !important;
        }
        .layui-form-select dl dd.layui-this {
            color: #ff98a0 !important;
        }
        .layui-btn-primary:hover {
            border-color: #ff98a0;
        }
        .laydate-day-holidays::before {
            content: "A";
            color: #FD4C5B;
            left: 2px;
            transform: scale(.8);
        }
        .laydate-B::after {
            content: "B";
            background-color: transparent;
            color: #23ade5;
            position: absolute;
            top: 0;
            right: 2px;
            font-size: 12px;
            transform: scale(.8);
        }

        .count{
            color: #ff98a0;
        }
        .layui-btn {
            padding: 0 10px !important;
        }
        .layui-btn-container .layui-btn {
            margin-right: 5px;
            margin-bottom: 1px;
        }
        .broadcost_A{
            margin-right: 74px;
            background-color: #FD4C5B;
        }
        .broadcost_B{
            background-color: #23ade5;
        }
    </style>
</head>
<body>
<!-- HTML Content -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-header">
            <p style="text-align: center">懒銀歌单【<span class="count" id="count">0</span>】&nbsp;&nbsp;2025直播天数【<span class="count" id="dateCount">0</span>】</p>
        </div>
        <div class="layui-card-body">
            <form class="layui-form layui-row layui-col-space16"  lay-filter="search-filter">
                <div class="layui-col-md3">
                    <div class="layui-input-wrap">
                        <input type="text" name="sName" value="" placeholder="歌名" class="layui-input" lay-affix="clear">
                    </div>
                </div>
                <div class="layui-col-md3">
                    <div class="layui-input-wrap">
                        <input type="text" name="sSinger" placeholder="歌手" lay-affix="clear" class="layui-input">
                    </div>
                </div>
                <div class="layui-col-md3">
                    <div class="layui-input-wrap">
                       <!-- <input type="text" name="sSign" placeholder="风格" lay-affix="clear" class="layui-input">-->
                        <select class="layui-input" name="sSign" placeholder="风格"  lay-affix="clear">
                            <option value="">风格</option>
                            <option value="悲伤情歌">悲伤情歌</option>
                            <option value="古风国风">古风国风</option>
                            <option value="活泼可爱">活泼可爱</option>
                            <option value="温柔治愈">温柔治愈</option>
                            <option value="民谣乐队杂食">民谣乐队杂食</option>
                            <!--<option value="喧嚣帅气">喧嚣帅气</option>-->
                        </select>
                    </div>
                </div>
                <div class="layui-col-md3">
                    <div class="layui-input-wrap">
                        <input type="text" name="sPre" placeholder="首字母" lay-affix="clear" class="layui-input">
                    </div>
                </div>
                <div class="layui-btn-container layui-col-xs12">
                    <button class="layui-btn search-btn" lay-submit lay-filter="playlist-search" id="btn-submit">搜索</button>
                    <button type="reset" class="layui-btn layui-btn-primary"  id="btn-clear">清除</button>
                    <button type="button" class="layui-btn layui-btn-primary" lay-on="test-page-wrap">热门歌曲</button>
                    <button type="button" class="layui-btn layui-btn-primary" id="live-date">直播日历</button>
                    <input type="hidden" id="live-date-val">
                </div>
            </form>

            <table class="layui-table" id="playList-table"></table>
        </div>
    </div>

</div>
<div id="rank-page" style="display: none;">
    <div style="padding:0px;">
        <table class="layui-table" id="rank-table"></table>
    </div>
</div>
<!-- 引入 layui.js -->
<script src="//unpkg.com/layui@2.11.4/dist/layui.js"></script>
<script>
    var playList_origin;
    layui.define(['jquery'], function(exports){
        var $ = layui.jquery;

        var fetchData = function(url, callback) {
            $.getJSON(url, function(data) {
                callback(data);
            });
        };

        exports('dataModule', {fetchData: fetchData}); // 导出模块功能
    });


    // Usage
    layui.use(function(){
        var $ = layui.$;
        var form = layui.form;
        var table = layui.table;
        var dataModule = layui.dataModule;
        var util = layui.util;
        var laydate = layui.laydate;

        var broadcastMap = new Map();
        var liveDateList_A;
        var liveDateList_B;
        dataModule.fetchData('./data/broadcastMap.json', function(data) {
            Object.entries(data).forEach(([key, value]) => {
                broadcastMap.set(key, value);
            });
        });
        dataModule.fetchData('./data/liveDateList_A.json', function(data) {
            liveDateList_A = data;
        });
        dataModule.fetchData('./data/liveDateList_B.json', function(data) {
            liveDateList_B = data;
        });

        dataModule.fetchData('./data/liveDateList.json', function(data) {
            $("#dateCount").text(data.length);
            // 渲染
            laydate.render({
                eventElem: '#live-date',
                trigger: 'click',
                elem: '#live-date-val',
                value: new Date(new Date().setDate(new Date().getDate() - 1)),
                id:'live-date',
                //holidays:[data,[]],
                showBottom: true,
                autoConfirm : false,
                btns: [],
                theme: ['#ff98a0','grid'],
                disabledDate: function(date, type){
                    return date.getTime() > Date.now();
                },

                change: function(value, date) {
                    this.cellRender(date);
                    $("#live-date").text("直播日历");
                },
                ready: function (date) {
                    var key = this.elem.attr('lay-key');
                    var panelEl = $('#layui-laydate' + key);
                    this._previewEl = panelEl.find('.layui-laydate-preview');
                    this.cellRender(date);
                    this.setValue(layui.util.toDateString(new Date(new Date().setDate(new Date().getDate() - 1)), 'yyyy-MM-dd'));
                },
                cellRender: function (ymd, render, info) {
                    var that = this;
                    var y = ymd.year;
                    var m = ymd.month;
                    var d = ymd.date;
                    var date = layui.util.toDateString(new Date(y, m-1, d), 'yyyy-MM-dd');
                    if (that._previewEl && (!info || (info && info.type === "date"))) {

                        if(broadcastMap.has(date)){
                            let broadcastList = broadcastMap.get(date);
                            let text = '';
                            for (let i = 0; i < broadcastList.length; i++) {
                                text += '<a class="broadcost_'+broadcastList[i].pt+' layui-btn layui-btn-xs layui-btn-normal" target="_blank" href="'+broadcastList[i].url+'">'+broadcastList[i].pt+'录播链接' + '</a>';
                            }
                            var tipsText = [
                                '<div class="preview-inner">',
                                text,
                                '</div>'
                            ].join('');
                            that._previewEl.html(tipsText);
                        }else{
                            var tipsText = [
                                '<div class="preview-inner">',
                                '<div style="color:#333;">暂无录播</div>',
                                '</div>'
                            ].join('');
                            that._previewEl.html(tipsText);
                        }
                    }
                    if (!render) return;

                    var is_A = liveDateList_A.includes(date);
                    var is_B = liveDateList_B.includes(date);
                    if (info.type == 'date') {
                        var clazz = [
                            'date-cell-inner',
                            is_A ? 'laydate-day-holidays' : '',
                            is_B ? 'laydate-B' : '',
                        ].join(' ');
                        var content = [
                            '<div class="' + clazz + '">',
                            '<b>' + d + '</b>',
                            '</div>',
                        ].join('');
                        // render(content)
                        // render($(content)[0])
                        var contentEl = $(content);
                        render(contentEl);
                    }


                }
            });
        });

        util.fixbar({
            top: true //返回顶部
            , css: { right: 15, bottom: 35,'border-radius': '50px' }
            , bgcolor: '#ff98a0'
            , click: function (type) {

            }
        });
        util.on('lay-on', {
            'test-page-wrap': function () {
                layer.open({
                    type: 1,
                    title: "热门歌曲 统计时间：07-14 24:00",
                    shade: 0.3, // 不显示遮罩
                    content: $('#rank-page'), // 捕获的元素
                    end: function () {
                        // layer.msg('关闭后的回调', {icon:6});
                    }
                });
            }
        });
        dataModule.fetchData('./data/playList.json', function(data) {
            playList_origin = data;
            $("#count").text(data.length);
            playList = playList_origin;
            // 创建表格实例
            table.render({
                elem: '#playList-table',
                size:'lg',
                data: playList,
                cols: [[
                    {type: 'numbers', title: '序号',width:60},
                    {field:'sName', title: '歌名',maxWidth:300,minWidth:150, templet: function(d) {
                            return d.sName+ (d.isHot > 0  ? '<img src="img/hot.gif" >' : '')+ (d.isNew> 0  ? '<img src="img/new.gif" >' : '');
                        }},
                    {field:'sSinger', title: '歌手', width:150},
                    {field:'sSign', title: '风格', width:120},
                    {field:'sumCount', title: '点歌次数', width:90},
                    {field:'sPre', title: '首字母', width:80}/*,
                    {field:'sUpDown', title: '升降调',  width:80}*/
                ]],

                //skin: 'line', // 表格风格
                even: true,
                page: false, // 是否显示分页
                limits: [10, 20, 50],
                limit: 20 // 每页默认显示的数量
            });

            var rankList = playList_origin.filter(song => song.isHot>0);
            rankList.sort(function (a,b) {

                return b.sumCount - a.sumCount == 0
                    ? (b.updateTime-a.updateTime ):(b.sumCount - a.sumCount);
            });

            // 点歌次数
            table.render({
                elem: '#rank-table',
                size:'lg',
                data: rankList,
                cols: [[
                    {field:'sName', title: '歌名',width:140},
                    {field:'sumCount', title: '点歌次数', width:90},
                    {field:'aCount', title: 'A', width:60, sort: true},
                    {field:'bCount', title: 'B', width:60, sort: true},
                    {field:'sSinger', title: '歌手', width:150},
                    {field:'sSign', title: '风格', width:120}
                ]],

                //skin: 'line', // 表格风格
                even: true,
                page: false, // 是否显示分页
            });
        });
        $('#btn-submit').on('click', function(){
            form.submit('search-filter', function(data){
                var field = data.field; // 获取表单全部字段值
                console.log(field);// 回调函数返回的 data 参数和提交事件中返回的一致
                search(field);

            });
            return false;
        });
        $('#btn-clear').on('click', function(){
            search({sName: '', sSinger: '', sSign: '', sPre: ''})
        });


        function search(field){
            let filter_list = []
            let cdata = playList_origin;
            if(field.sName == "" && field.sSinger == "" && field.sSign == ""  && field.sPre == ""){
                filter_list = cdata;
            }else if(field.sPre =="open"){
                table.reload('playList-table', {
                    cols: [[
                        {type: 'numbers', title: '序号',width:60},
                        {field:'sName', title: '歌名',maxWidth:300,minWidth:150},
                        {field:'sSinger', title: '歌手', width:150},
                        {field:'sSign', title: '风格', width:120},
                        {field:'sumCount', title: '点歌次数', width:90},
                        {field:'sPre', title: '首字母', width:80},
                        {field:'sUpDown', title: '升降调',  width:80}
                    ]],
                });
            }else{
                $.each(cdata, function (i, row) {
                    var isSearchInRow_sName = false
                    var isSearchInRow_sSinger = false;
                    var isSearchInRow_sSign = false;
                    var isSearchInRow_sPre = false;
                    if(field.sName != "" && row.sName.toUpperCase().indexOf(field.sName.toUpperCase())> -1){
                        isSearchInRow_sName = true;
                    }else{
                        if(field.sName == ""){
                            isSearchInRow_sName = true;
                        }
                    }
                    if(field.sSinger != "" && row.sSinger.toUpperCase().indexOf(field.sSinger.toUpperCase())> -1){
                        isSearchInRow_sSinger = true;
                    }else{
                        if(field.sSinger == ""){
                            isSearchInRow_sSinger = true;
                        }
                    }
                    if(field.sSign != "" && row.sSign.indexOf(field.sSign)> -1){
                        isSearchInRow_sSign = true;
                    }else{
                        if(field.sSign == ""){
                            isSearchInRow_sSign = true;
                        }
                    }
                    if(field.sPre != "" && row.sPre == field.sPre.toUpperCase()){
                        isSearchInRow_sPre = true;
                    }else{
                        if(field.sPre == ""){
                            isSearchInRow_sPre = true;
                        }
                    }
                    if (isSearchInRow_sName && isSearchInRow_sSinger && isSearchInRow_sSign && isSearchInRow_sPre) {
                        filter_list.push(row)

                    }
                });
            }
            // 执行搜索重载
            table.reload('playList-table', {
                data: filter_list,
            });
        }
    });

</script>
</body>
</html>